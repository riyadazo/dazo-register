<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#B4B6B9">
<title>ãƒ¬ã‚¸</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#B4B6B9; --s1:#C2C4C7; --s2:#CCCECF; --s3:#D8DADB;
  --border:#A0A2A5; --accent:#4E5F6D; --accent-dim:#3A4B58;
  --green:#2E6B4A; --red:#d94444; --blue:#3A5F94;
  --text:#18191B; --text2:#404347; --text3:#747880;
  --r:14px; --rs:9px;
}
* { box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent; }
html,body { height:100%; }
body { font-family:'Noto Sans JP',sans-serif; background:#B4B6B9; background-color:#B4B6B9; color:var(--text); overflow:hidden; height:100dvh; display:flex; flex-direction:column; }

nav { display:flex; background:var(--s1); border-top:1px solid var(--border); padding-bottom:env(safe-area-inset-bottom); flex-shrink:0; z-index:50; }
.nav-btn { flex:1; padding:10px 4px 8px; background:none; border:none; color:var(--text3); cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:3px; font-family:'Noto Sans JP',sans-serif; font-size:10px; font-weight:700; transition:color .2s; }
.nav-btn.active { color:var(--accent); }
.nav-btn svg { width:20px; height:20px; stroke-width:2; }

.pages { flex:1; overflow:hidden; position:relative; }
.page { position:absolute; inset:0; overflow-y:auto; overflow-x:hidden; padding:10px 12px 14px; opacity:0; pointer-events:none; transition:opacity .2s; -webkit-overflow-scrolling:touch; }
.page.active { opacity:1; pointer-events:all; }

h2 { font-size:16px; font-weight:900; letter-spacing:-.3px; margin-bottom:6px; }
.sub { font-size:11px; color:var(--text2); margin-bottom:10px; }
.card { background:var(--s1); border-radius:var(--r); border:1px solid var(--border); padding:16px; margin-bottom:12px; }
.section-label { font-size:10px; font-weight:700; color:var(--text3); letter-spacing:1.5px; text-transform:uppercase; margin-bottom:10px; }

.btn { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:13px; border-radius:var(--rs); font-family:'Noto Sans JP',sans-serif; font-size:15px; font-weight:700; border:none; cursor:pointer; transition:all .12s; }
.btn:active { transform:scale(.97); }
.btn-primary { background:var(--accent); color:#fff; }
.btn-primary:active { background:var(--accent-dim); }
.btn-red { background:var(--red); color:#fff; }
.btn-ghost { background:var(--s2); color:var(--text); border:1px solid var(--border); }
.btn-ghost:active { background:var(--s3); }
.btn-sm { padding:9px 14px; font-size:13px; width:auto; border-radius:var(--rs); }

.fgroup { margin-bottom:14px; }
.fgroup label { display:block; font-size:11px; font-weight:700; color:var(--text2); margin-bottom:6px; letter-spacing:.5px; }
.finput { width:100%; padding:13px 14px; background:var(--s2); border:1px solid var(--border); border-radius:var(--rs); color:var(--text); font-family:'Noto Sans JP',sans-serif; font-size:16px; outline:none; transition:border-color .2s; }
.finput:focus { border-color:var(--accent); }
textarea.finput { resize:vertical; min-height:70px; }
.new-badge { display:inline-block; background:var(--red); color:#fff; font-size:9px; font-weight:900; padding:2px 5px; border-radius:4px; letter-spacing:.5px; line-height:1.2; vertical-align:middle; margin-left:3px; }

/* ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼ãƒ©ãƒ™ãƒ« */
.cat-label {
  display:inline-block; padding:2px 6px; border-radius:4px;
  font-size:9px; font-weight:700; letter-spacing:.3px;
  line-height:1.4; white-space:nowrap; max-width:100%;
  overflow:hidden; text-overflow:ellipsis;
}

/* å•†å“ã‚°ãƒªãƒƒãƒ‰ */
.product-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(80px,1fr)); gap:5px; margin-bottom:8px; }
.product-btn {
  background:var(--s1); border:1px solid var(--border); border-radius:var(--rs);
  padding:8px 5px 6px; cursor:pointer; text-align:center; transition:all .12s;
  min-height:72px; display:flex; flex-direction:column; justify-content:center; align-items:center; gap:1px;
  position:relative; overflow:hidden;
}
.product-btn:active { background:var(--s3); border-color:var(--accent); transform:scale(.96); }
.product-btn .pthumb-img { width:34px; height:34px; border-radius:5px; object-fit:cover; margin-bottom:2px; }
.product-btn .pthumb-emoji { font-size:26px; line-height:1; margin-bottom:2px; }
.product-btn .pname { font-size:11px; font-weight:700; line-height:1.3; width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; padding:0 4px; }
.product-btn .pprice { font-family:'DM Mono',monospace; font-size:12px; color:var(--accent); }
.product-btn .pnew { position:absolute; top:4px; right:4px; background:var(--red); color:#fff; font-size:8px; font-weight:900; padding:1px 4px; border-radius:3px; }
.product-btn .pqty { position:absolute; top:4px; left:4px; background:var(--accent); color:#fff; font-size:9px; font-weight:900; padding:1px 5px; border-radius:99px; font-family:'DM Mono',monospace; line-height:1.4; }

/* ã‚«ãƒ¼ãƒˆ */
.cart-wrap { background:var(--s1); border:1px solid var(--border); border-radius:var(--r) var(--r) 0 0; margin-bottom:0; overflow:hidden; border-bottom:none; }
.cart-head { padding:7px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:6px; cursor:pointer; user-select:none; }
.cart-head-label { font-size:11px; font-weight:700; color:var(--text2); letter-spacing:.5px; flex:1; display:flex; align-items:center; gap:5px; }
.cart-chevron { font-size:10px; color:var(--text3); transition:transform .2s; line-height:1; }
.cart-chevron.open { transform:rotate(180deg); }
.cart-clear { background:none; border:none; color:var(--red); font-size:11px; font-weight:700; cursor:pointer; padding:2px 6px; }
.cart-list { max-height:160px; overflow-y:auto; transition:max-height .22s ease, opacity .18s ease; overflow:hidden; }
.cart-list.collapsed { max-height:0 !important; opacity:0; }
.cart-empty { padding:18px; text-align:center; color:var(--text3); font-size:12px; }
.cart-item { padding:5px 12px; display:flex; align-items:center; gap:8px; border-bottom:none; animation:fadeSlide .15s ease; }
@keyframes fadeSlide { from{opacity:0;transform:translateX(-6px)} to{opacity:1} }
.ci-name { flex:1; font-size:12px; font-weight:600; color:var(--text2); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.ci-price { font-family:'DM Mono',monospace; font-size:12px; color:var(--text2); min-width:56px; text-align:right; }
.ci-qty { display:flex; align-items:center; gap:5px; }


/* åˆè¨ˆ */
.total-wrap { background:var(--s1); border:1px solid var(--border); border-radius:0 0 var(--r) var(--r); padding:8px 12px 10px; margin-bottom:8px; border-top:1px solid var(--border); flex-shrink:0; }
.trow { display:flex; justify-content:space-between; padding:2px 0; font-size:12px; }
.trow .tval { font-family:'DM Mono',monospace; }
.trow.grand { border-top:1px solid var(--border); margin-top:5px; padding-top:6px; }
.trow.grand .tlbl { font-size:13px; font-weight:700; display:flex; align-items:baseline; gap:8px; }
.trow.grand .tval { font-size:23px; font-weight:700; color:var(--accent); }

/* ç´™å¹£ãƒ†ãƒ³ã‚­ãƒ¼ */
.cashkey-wrap { background:var(--s2); border-radius:var(--rs); padding:8px 10px 6px; margin-bottom:8px; border:1px solid var(--border); }
.cashkey-top-row { display:flex; align-items:center; gap:6px; margin-bottom:6px; }
.cashkey-label { font-size:11px; color:var(--text3); font-weight:700; white-space:nowrap; }
.cashkey-value { font-family:'DM Mono',monospace; font-size:18px; font-weight:700; color:var(--text2); flex:1; text-align:right; }
.cashkey-clr-btn { flex-shrink:0; background:none; border:none; color:var(--red); font-size:11px; font-weight:700; cursor:pointer; padding:2px 6px; white-space:nowrap; font-family:'Noto Sans JP',sans-serif; }
.cashkey-clr-btn:active { opacity:.7; }
.cashkey-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:5px; margin-top:4px; }
.cashkey-btn { padding:11px 4px; border-radius:var(--rs); background:var(--s1); border:1px solid var(--border); font-family:'DM Mono',monospace; font-size:17px; font-weight:700; color:var(--text); cursor:pointer; text-align:center; transition:all .1s; }
.cashkey-btn:active { background:var(--s3); transform:scale(.95); }

/* ãŠé‡£ã‚Šã‚¨ãƒªã‚¢ï¼ˆå¸¸æ™‚ç¢ºä¿ï¼‰ */
.change-area {
  margin-top:4px; min-height:46px;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
}
.cr-label { font-size:11px; color:var(--text3); margin-bottom:1px; font-weight:700; }
.cr-amount { font-family:'DM Mono',monospace; font-size:25px; font-weight:700; color:var(--green); }
.cr-amount.negative { color:var(--red); }
.cr-placeholder { font-size:11px; color:var(--text3); }

/* å•†å“ç®¡ç† */
.product-card { background:var(--s1); border:1px solid var(--border); border-radius:var(--r); display:flex; align-items:center; gap:10px; padding:13px 14px; margin-bottom:8px; transition:box-shadow .15s, opacity .15s; user-select:none; }
.product-card.drag-over { border-color:var(--accent); border-style:dashed; background:var(--s2); }
.product-card.dragging { opacity:.35; }
.drag-handle { flex-shrink:0; width:28px; height:34px; display:flex; align-items:center; justify-content:center; cursor:grab; color:var(--text3); touch-action:none; border-radius:6px; }
.drag-handle:active { cursor:grabbing; background:var(--s2); }
.drag-handle svg { pointer-events:none; }
.pc-thumb { width:44px; height:44px; border-radius:8px; overflow:hidden; background:var(--s2); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.pc-thumb img { width:100%; height:100%; object-fit:cover; }
.pc-thumb .pc-emoji { font-size:24px; line-height:1; }
.pc-info { flex:1; min-width:0; }
.pc-name { font-size:14px; font-weight:700; }
.pc-price { font-family:'DM Mono',monospace; font-size:13px; color:var(--accent); margin-top:2px; }
.pc-actions { display:flex; gap:6px; }
.icon-btn { width:34px; height:34px; border-radius:var(--rs); display:flex; align-items:center; justify-content:center; border:none; cursor:pointer; transition:all .12s; }
.icon-btn:active { transform:scale(.92); }
.icon-btn-edit { background:rgba(74,111,165,.12); color:var(--blue); }
.icon-btn-del  { background:rgba(224,85,85,.12); color:var(--red); }

/* çµµæ–‡å­—ãƒ”ãƒƒã‚«ãƒ¼ */
.emoji-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; max-height:180px; overflow-y:auto; background:var(--s2); border:1px solid var(--border); border-radius:var(--rs); padding:8px; margin-top:8px; }
.emoji-btn { font-size:22px; padding:4px; border:none; background:none; cursor:pointer; border-radius:6px; }
.emoji-btn:active { background:var(--s3); }
.thumb-preview { width:48px; height:48px; border-radius:8px; overflow:hidden; background:var(--s2); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; }
.thumb-preview .prev-emoji { font-size:28px; }
.thumb-type-tabs { display:flex; gap:6px; margin-bottom:10px; }
.thumb-tab { flex:1; padding:8px; border-radius:var(--rs); font-size:12px; font-weight:700; border:1px solid var(--border); background:var(--s2); color:var(--text2); cursor:pointer; }
.thumb-tab.active { background:var(--accent); color:#fff; border-color:var(--accent); }

/* ãƒ­ã‚´ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
.logo-preview-wrap { display:flex; align-items:center; gap:12px; margin-bottom:10px; }
.logo-preview { width:80px; height:50px; border-radius:var(--rs); background:var(--s2); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0; }
.logo-preview img { max-width:100%; max-height:100%; object-fit:contain; filter:grayscale(1); }
.logo-preview .logo-empty { font-size:11px; color:var(--text3); text-align:center; }

/* ãƒ¢ãƒ¼ãƒ€ãƒ« */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:flex; align-items:flex-end; justify-content:center; z-index:200; opacity:0; pointer-events:none; transition:opacity .2s; }
.modal-overlay.open { opacity:1; pointer-events:all; }
.modal { background:var(--s1); border-radius:20px 20px 0 0; border-top:1px solid var(--border); width:100%; max-width:500px; padding:20px 20px calc(20px + env(safe-area-inset-bottom)); transform:translateY(30px); transition:transform .25s; max-height:92dvh; overflow-y:auto; }
.modal-overlay.open .modal { transform:translateY(0); }
.modal-title { font-size:18px; font-weight:900; margin-bottom:18px; }

/* å±¥æ­´ */
.today-summary { background:linear-gradient(135deg,rgba(92,107,122,.10) 0%,rgba(92,107,122,.04) 100%); border:1px solid rgba(92,107,122,.25); border-radius:var(--r); padding:16px; margin-bottom:16px; }
.ts-title { font-size:11px; font-weight:700; color:var(--accent); letter-spacing:1px; margin-bottom:10px; }
.ts-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.ts-item .ts-label { font-size:10px; color:var(--text2); margin-bottom:3px; }
.ts-item .ts-value { font-family:'DM Mono',monospace; font-size:20px; font-weight:700; color:var(--accent); }
.ts-item .ts-unit { font-size:11px; color:var(--text2); }
.history-item { background:var(--s1); border:1px solid var(--border); border-radius:var(--r); padding:14px; margin-bottom:8px; cursor:pointer; transition:border-color .15s; }
.history-item:active { border-color:var(--accent); }
.history-item.archived { opacity:.5; border-style:dashed; }
.hi-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px; }
.hi-left { display:flex; flex-direction:column; gap:3px; }
.hi-time { font-size:12px; color:var(--text2); }
.hi-amount { font-family:'DM Mono',monospace; font-size:18px; font-weight:700; color:var(--accent); }
.hi-archived-label { font-size:10px; font-weight:700; color:var(--red); letter-spacing:.5px; }
.hi-items { display:flex; flex-wrap:wrap; gap:5px; }
.hi-tag { background:var(--s2); border:1px solid var(--border); border-radius:6px; padding:3px 8px; font-size:11px; color:var(--text2); }
.date-sep { font-size:11px; font-weight:700; color:var(--text3); letter-spacing:1px; padding:14px 0 8px; }
.hdi-row { display:flex; justify-content:space-between; padding:7px 0; border-bottom:1px solid var(--border); font-size:13px; }
.hdi-row:last-child { border-bottom:none; }
.hdi-val { font-family:'DM Mono',monospace; color:var(--text2); }

/* CSVå‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç† */
.archive-item-row { background:var(--s2); border:1px solid var(--border); border-radius:var(--rs); padding:12px 14px; margin-bottom:8px; }
.air-header { display:flex; justify-content:space-between; margin-bottom:4px; }
.air-time { font-size:12px; color:var(--text2); }
.air-amount { font-family:'DM Mono',monospace; font-size:15px; font-weight:700; color:var(--accent); }
.air-memo { font-size:11px; color:var(--text3); font-style:italic; margin-bottom:8px; }
.air-btns { display:flex; gap:6px; }

/* é ˜åæ›¸ */
.receipt-modal .modal { background:#f5f5f3; color:#252628; }

/* ãƒˆãƒ¼ã‚¹ãƒˆ */
.toast { position:fixed; bottom:90px; left:50%; transform:translateX(-50%) translateY(10px); background:var(--s3); border:1px solid var(--border); border-radius:99px; padding:10px 20px; font-size:13px; font-weight:700; z-index:300; opacity:0; transition:all .25s; white-space:nowrap; pointer-events:none; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
.toast.success { border-color:var(--green); color:var(--green); }
.toast.error { border-color:var(--red); color:var(--red); }
::-webkit-scrollbar { width:0; }
</style>
</head>
<body>

<nav>
  <button class="nav-btn active" onclick="showPage('register',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="3" width="20" height="14" rx="2"/><path d="M8 21h8M12 17v4"/><path d="M6 7h4M6 10h2"/><path d="M14 7h4v6h-4z"/></svg>ãƒ¬ã‚¸
  </button>
  <button class="nav-btn" onclick="showPage('products',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 7H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/><path d="M16 3l2 4H6l2-4"/><path d="M12 12v5M9.5 14.5h5"/></svg>å•†å“
  </button>
  <button class="nav-btn" onclick="showPage('history',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 8v4l3 3"/><circle cx="12" cy="12" r="9"/></svg>å±¥æ­´
  </button>
  <button class="nav-btn" onclick="showPage('settings',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="3"/><path d="M12 2v2M12 20v2M2 12H4M20 12h2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>è¨­å®š
  </button>
</nav>

<div class="pages">

<!-- ãƒ¬ã‚¸ -->
<div class="page active" id="p-register">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <h2 style="margin-bottom:0">ãƒ¬ã‚¸</h2>
    <span id="cart-timer" style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;letter-spacing:.5px">â€”:â€”â€”</span>
  </div>
  <div class="product-grid" id="product-grid"></div>
  <div class="cart-wrap">
    <div class="cart-head" onclick="toggleCartAccordion()">
      <span class="cart-head-label">
        <span class="cart-chevron" id="cart-chevron">â–²</span>
        ã‚«ãƒ¼ãƒˆ
        <span id="cart-head-summary" style="font-size:10px;color:var(--text3);font-weight:600"></span>
      </span>
      <button class="cart-clear" onclick="event.stopPropagation();clearCart()">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="cart-list" id="cart-list"><div class="cart-empty">å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div></div>
  </div>
  <div class="total-wrap">
    <div class="trow grand" style="border-top:none;margin-top:0;padding-top:4px">
      <span class="tlbl" id="cart-total-label">åˆè¨ˆ</span>
      <span class="tval" id="total">Â¥0</span>
    </div>
  </div>
  <!-- ãƒ†ãƒ³ã‚­ãƒ¼ -->
  <div class="cashkey-wrap">
    <div class="cashkey-top-row">
      <span class="cashkey-label">ãŠé‡£ã‚Šè¨ˆç®—</span>
      <span class="cashkey-value" id="cashkey-display">Â¥â€”</span>
      <button class="cashkey-clr-btn" onclick="cashkeyClear()">CLR</button>
    </div>
    <div class="cashkey-grid">
      <button class="cashkey-btn" onclick="cashkeyTap(10000)">Â¥10,000</button>
      <button class="cashkey-btn" onclick="cashkeyTap(5000)">Â¥5,000</button>
      <button class="cashkey-btn" onclick="cashkeyTap(1000)">Â¥1,000</button>
      <button class="cashkey-btn" onclick="cashkeyTap(500)">Â¥500</button>
    </div>
    <!-- ãŠé‡£ã‚Šã‚¨ãƒªã‚¢å¸¸æ™‚ç¢ºä¿ -->
    <div class="change-area" id="change-area">
      <span class="cr-placeholder">â€”</span>
    </div>
  </div>
  <button class="btn btn-primary" onclick="checkout()" id="checkout-btn" disabled>
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
    ä¼šè¨ˆã™ã‚‹
  </button>
</div>

<!-- å•†å“ç®¡ç† -->
<div class="page" id="p-products">
  <h2>å•†å“ç®¡ç†</h2>
  <p class="sub">â˜° ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ</p>
  <button class="btn btn-primary" onclick="openProductModal()" style="margin-bottom:16px">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    æ–°ã—ã„å•†å“ã‚’è¿½åŠ 
  </button>
  <div id="product-list-wrap"></div>
</div>

<!-- å±¥æ­´ -->
<div class="page" id="p-history">
  <h2>å£²ä¸Šå±¥æ­´</h2>
  <p class="sub">ä¼šè¨ˆã”ã¨ã«è‡ªå‹•ä¿å­˜</p>
  <div id="today-summary-wrap"></div>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
    <button class="btn btn-ghost" id="csv-export-btn" onclick="startCsvExport()" style="flex:1">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      CSVã§å£²ä¸Šå‡ºåŠ›
    </button>
    <div id="csv-exported-badge" style="display:none;flex-shrink:0;padding:6px 10px;border-radius:99px;background:rgba(46,107,74,.12);border:1px solid rgba(46,107,74,.3);font-size:11px;font-weight:700;color:var(--green)">âœ“ å‡ºåŠ›æ¸ˆã¿</div>
  </div>
  <div id="history-list-wrap"></div>
</div>

<!-- è¨­å®š -->
<div class="page" id="p-settings">
  <h2>è¨­å®š</h2>
  <p class="sub">ã‚µãƒ¼ã‚¯ãƒ«ãƒ»åº—èˆ—æƒ…å ±</p>
  <div class="card">
    <div class="section-label">é ˜åæ›¸ è¡¨ç¤ºæƒ…å ±</div>
    <div class="fgroup"><label>ã‚µãƒ¼ã‚¯ãƒ«å / åº—èˆ—å</label><input type="text" class="finput" id="store-name" placeholder="ä¾‹: â—‹â—‹ã‚µãƒ¼ã‚¯ãƒ«" oninput="saveSetting('storeName',this.value)"></div>
    <div class="fgroup"><label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆå•ã„åˆã‚ã›å…ˆï¼‰</label><input type="text" class="finput" id="store-email" placeholder="ä¾‹: info@example.com" oninput="saveSetting('storeEmail',this.value)"></div>
    <div class="fgroup"><label>ä¸€è¨€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</label><input type="text" class="finput" id="store-message" placeholder="ä¾‹: ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼" maxlength="140" oninput="saveSetting('storeMessage',this.value)"><div style="font-size:10px;color:var(--text3);text-align:right;margin-top:3px">æœ€å¤§140å­—</div></div>
    <div class="fgroup">
      <label>åº—èˆ—ãƒ­ã‚´ï¼ˆé ˜åæ›¸ã«å°åˆ·ãƒ»ç™½é»’å¤‰æ›ã•ã‚Œã¾ã™ï¼‰</label>
      <div class="logo-preview-wrap">
        <div class="logo-preview" id="logo-preview"><span class="logo-empty">ãƒ­ã‚´ãªã—</span></div>
        <div style="flex:1;display:flex;flex-direction:column;gap:8px">
          <input type="file" id="logo-file-input" accept="image/*" style="display:none" onchange="onLogoSelected(this)">
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('logo-file-input').click()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
            ç”»åƒã‚’é¸ã¶
          </button>
          <button class="btn btn-ghost btn-sm" id="logo-clear-btn" onclick="clearLogo()" style="display:none;color:var(--red)">ãƒ­ã‚´ã‚’å‰Šé™¤</button>
        </div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="section-label">ãƒ‡ãƒ¼ã‚¿ç®¡ç†</div>
    <button class="btn btn-ghost" onclick="exportJson()" style="margin-bottom:8px">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆJSONï¼‰
    </button>
    <button class="btn btn-red btn-sm" onclick="confirmClearHistory()" style="width:auto">å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>
  </div>
  <div class="card">
    <div class="section-label">ãƒ‡ãƒ¼ã‚¿ä¿å­˜å ´æ‰€</div>
    <div style="font-size:13px;color:var(--text2);line-height:1.9">
      <div style="margin-bottom:8px">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯<strong>ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã®IndexedDB</strong>ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚</div>
      <div style="font-size:11px;color:var(--text3);line-height:1.7">
        ãƒ»åŒã˜ç«¯æœ«ãƒ»åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆä¾‹: Chromeï¼‰ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½<br>
        ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã›ã‚“<br>
        ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒ»ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§æ¶ˆå¤±ã—ã¾ã™<br>
        ãƒ»ä»–ã®ç«¯æœ«ãƒ»ãƒ–ãƒ©ã‚¦ã‚¶ã¨ã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“<br>
        ãƒ»å®šæœŸçš„ã«JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æ¨å¥¨ã—ã¾ã™
      </div>
    </div>
    <div id="db-storage-info" style="margin-top:10px;font-size:11px;color:var(--text3)">ä½¿ç”¨å®¹é‡ã‚’ç¢ºèªä¸­...</div>
  </div>
  <div class="card">
    <div class="section-label">ã‚¢ãƒ—ãƒªæƒ…å ±</div>
    <div style="font-size:13px;color:var(--text2);line-height:1.8">ãƒãƒ¼ã‚¸ãƒ§ãƒ³: 3.1.0</div>
  </div>
</div>
</div><!-- /pages -->

<!-- å•†å“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="product-modal">
  <div class="modal">
    <div class="modal-title" id="product-modal-title">å•†å“ã‚’è¿½åŠ </div>
    <input type="hidden" id="edit-product-id">
    <div class="fgroup">
      <label>ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰</label>
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
        <div class="thumb-preview" id="thumb-preview"><span style="font-size:11px;color:var(--text3)">ãªã—</span></div>
        <div style="flex:1">
          <div class="thumb-type-tabs">
            <button class="thumb-tab active" id="tab-emoji" onclick="switchThumbTab('emoji')">ğŸ˜Š çµµæ–‡å­—</button>
            <button class="thumb-tab" id="tab-image" onclick="switchThumbTab('image')">ğŸ–¼ ç”»åƒ</button>
            <button class="thumb-tab" id="tab-none" onclick="clearThumb()">ãªã—</button>
          </div>
        </div>
      </div>
      <div id="thumb-emoji-section">
        <div class="emoji-grid" id="emoji-grid"></div>
        <details style="margin-top:8px">
          <summary style="font-size:11px;color:var(--text3);cursor:pointer;user-select:none;padding:4px 0">ï¼‹ çµµæ–‡å­—ã‚’ç›´æ¥å…¥åŠ›</summary>
          <input type="text" class="finput" id="pm-emoji" placeholder="ä¾‹: ğŸ‰" style="font-size:22px;letter-spacing:4px;margin-top:8px" oninput="onEmojiInput(this.value)" maxlength="2">
        </details>
      </div>
      <div id="thumb-image-section" style="display:none">
        <input type="file" id="pm-image-file" accept="image/*" style="display:none" onchange="onImageSelected(this)">
        <button class="btn btn-ghost" onclick="document.getElementById('pm-image-file').click()">ç«¯æœ«ã‹ã‚‰ç”»åƒã‚’é¸ã¶</button>
      </div>
    </div>
    <div class="fgroup"><label>å•†å“å</label><input type="text" class="finput" id="pm-name" placeholder="ä¾‹: åŒäººèªŒ Vol.1"></div>
    <div class="fgroup"><label>ä¾¡æ ¼ï¼ˆç¨è¾¼ï¼‰</label><input type="number" class="finput" id="pm-price" placeholder="500" inputmode="numeric"></div>
    <div class="fgroup"><label>ã‚«ãƒ†ã‚´ãƒªï¼ˆä»»æ„ï¼‰</label><input type="text" class="finput" id="pm-category" placeholder="ä¾‹: æ–°åˆŠã€æ—¢åˆŠã€ã‚°ãƒƒã‚º"></div>
    <div class="fgroup" style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px">
      <label style="margin-bottom:0;font-size:13px;font-weight:700">NEWã‚¢ã‚¤ã‚³ãƒ³</label>
      <button id="new-toggle" onclick="toggleNew()" style="padding:8px 20px;border-radius:99px;font-size:13px;font-weight:700;border:1px solid var(--border);background:var(--s2);color:var(--text2);cursor:pointer;transition:all .15s">OFF</button>
    </div>
    <button class="btn btn-primary" onclick="saveProduct()" style="margin-bottom:10px">ä¿å­˜ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeProductModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- å±¥æ­´è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="history-modal">
  <div class="modal">
    <div id="history-detail-content"></div>
    <button class="btn btn-ghost" onclick="closeHistoryModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="archive-modal">
  <div class="modal">
    <div class="modal-title">ã“ã®ä¼šè¨ˆã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:14px;line-height:1.6">é–“é•ã„ä¼šè¨ˆãªã©ã‚’å£²ä¸Šé›†è¨ˆã‹ã‚‰é™¤å¤–ã—ã¾ã™ã€‚å±¥æ­´ã«ã¯è–„ãæ®‹ã‚Šã¾ã™ã€‚</div>
    <input type="hidden" id="archive-target-id">
    <div class="fgroup"><label>ç†ç”±ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label><textarea class="finput" id="archive-memo" placeholder="ä¾‹: å…¥åŠ›ãƒŸã‚¹ã€é‡è¤‡ä¼šè¨ˆã€è¿”é‡‘å¯¾å¿œãªã©"></textarea></div>
    <button class="btn btn-red" onclick="confirmArchive()" style="margin-bottom:10px">ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeArchiveModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- CSVå‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="csv-archive-modal">
  <div class="modal">
    <div class="modal-title">ãƒ¬ã‚¸ç· ã‚ â€” ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†</div>
    <div style="font-size:13px;color:var(--text2);margin-bottom:10px;line-height:1.6">å…¨ä»¶å‡¦ç†ã—ã¦ã‹ã‚‰CSVã‚’å‡ºåŠ›ã§ãã¾ã™ã€‚</div>
    <div style="display:flex;gap:8px;margin-bottom:14px">
      <button class="btn btn-red btn-sm" onclick="bulkArchiveAction('delete')">å…¨ä»¶å‰Šé™¤</button>
      <button class="btn btn-ghost btn-sm" onclick="bulkArchiveAction('merge')">å…¨ä»¶ãƒãƒ¼ã‚¸</button>
    </div>
    <div id="csv-archive-list"></div>
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border)">
      <button class="btn btn-primary" id="csv-proceed-btn" onclick="proceedCsvExport()" disabled>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        CSVå‡ºåŠ›ã™ã‚‹
      </button>
    </div>
    <button class="btn btn-ghost" onclick="closeCsvArchiveModal()" style="margin-top:8px">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- ä¼šè¨ˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="checkout-modal">
  <div class="modal">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-size:40px;margin-bottom:8px">âœ“</div>
      <div style="font-size:20px;font-weight:900;color:var(--green)">ä¼šè¨ˆå®Œäº†</div>
      <div style="font-size:13px;color:var(--text2);margin-top:4px" id="co-summary"></div>
    </div>
    <div id="co-change-display" style="text-align:center;margin-bottom:16px;display:none">
      <div style="font-size:12px;color:var(--text2)">ãŠé‡£ã‚Š</div>
      <div style="font-family:'DM Mono',monospace;font-size:32px;font-weight:700" id="co-change"></div>
    </div>
    <button class="btn btn-primary" onclick="showReceiptModal()" style="margin-bottom:8px">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      é ˜åæ›¸ã‚’è¡¨ç¤º
    </button>
    <button class="btn btn-ghost" onclick="closeCheckoutModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- é ˜åæ›¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay receipt-modal" id="receipt-modal">
  <div class="modal">
    <div class="modal-title">é ˜åæ›¸</div>
    <div style="text-align:center;margin-bottom:12px">
      <canvas id="receipt-canvas" style="max-width:100%;border:1px solid #ddd;border-radius:6px;background:#fff;display:block;margin:0 auto"></canvas>
    </div>
    <button class="btn btn-primary" onclick="downloadReceiptPng()" style="margin-bottom:8px">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      PNGã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆå°åˆ·ç”¨ï¼‰
    </button>
    <button class="btn btn-ghost" onclick="closeReceiptModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<!-- ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="dl-complete-modal">
  <div class="modal">
    <div style="text-align:center;margin-bottom:16px">
      <div style="font-size:32px;margin-bottom:6px">ğŸ“¥</div>
      <div class="modal-title" id="dl-complete-title" style="margin-bottom:4px">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†</div>
      <div style="font-size:12px;color:var(--text3)" id="dl-complete-filename"></div>
    </div>
    <div id="dl-complete-guide" style="background:var(--s2);border:1px solid var(--border);border-radius:var(--rs);padding:14px;margin-bottom:16px;font-size:13px;line-height:1.8;color:var(--text2)"></div>
    <button class="btn btn-ghost" onclick="closeDlCompleteModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ===========================
// ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ã‚¬ã‚¤ãƒ‰
// ===========================
function detectOS(){
  const ua=navigator.userAgent;
  if(/iPad|iPhone|iPod/.test(ua))return'ios';
  if(/Android/.test(ua))return'android';
  if(/Macintosh/.test(ua))return'mac';
  if(/Windows/.test(ua))return'windows';
  return'other';
}

function showDlCompleteModal(type, filename){
  const os=detectOS();
  document.getElementById('dl-complete-filename').textContent=filename;

  const guides={
    csv:{
      ios:{
        title:'CSVå‡ºåŠ›å®Œäº†',
        steps:[
          'â‘  Safari ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å³ã® â†“ ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’ã‚¿ãƒƒãƒ—',
          'â‘¡ ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚¿ãƒƒãƒ— â†’ ã€Œå…±æœ‰ã€â†’ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€',
          'â‘¢ iCloud Drive ã¾ãŸã¯ã€Œã“ã®iPhoneå†…ã€â†’ ä»»æ„ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ä¿å­˜',
          'â‘£ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒª â†’ ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ã§ç¢ºèªã§ãã¾ã™',
        ],
        note:'ğŸ’¡ Excel / Numbers ã§é–‹ãå ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é•·æŠ¼ã— â†’ã€Œåˆ¥ã®ã‚¢ãƒ—ãƒªã§é–‹ãã€â†’ ã‚¢ãƒ—ãƒªã‚’é¸æŠ'
      },
      android:{
        title:'CSVå‡ºåŠ›å®Œäº†',
        steps:[
          'â‘  ç”»é¢ä¸Šéƒ¨ã®é€šçŸ¥ãƒãƒ¼ã‚’ä¸‹ã«ã‚¹ãƒ¯ã‚¤ãƒ—',
          'â‘¡ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ã®é€šçŸ¥ã‚’ã‚¿ãƒƒãƒ— â†’ ãƒ•ã‚¡ã‚¤ãƒ«ãŒé–‹ãã¾ã™',
          'â‘¢ ã¾ãŸã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒª â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€ã§ç¢ºèª',
        ],
        note:'ğŸ’¡ Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§é–‹ãå ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é•·æŠ¼ã— â†’ã€Œåˆ¥ã®ã‚¢ãƒ—ãƒªã§é–‹ãã€'
      },
      mac:{
        title:'CSVå‡ºåŠ›å®Œäº†',
        steps:[
          'â‘  Finder â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆâŒ˜+Option+Lï¼‰',
          'â‘¡ ã¾ãŸã¯ Dock ã®ã€Œãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯',
          'â‘¢ Excel / Numbers / Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ãƒ‰ãƒ©ãƒƒã‚°ã§é–‹ã‘ã¾ã™',
        ],
        note:''
      },
      windows:{
        title:'CSVå‡ºåŠ›å®Œäº†',
        steps:[
          'â‘  ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆWin+E â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰',
          'â‘¡ ã¾ãŸã¯ ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å±¥æ­´ï¼ˆCtrl+Jï¼‰ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯',
          'â‘¢ Excel / Google ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§é–‹ã‘ã¾ã™',
        ],
        note:''
      },
      other:{
        title:'CSVå‡ºåŠ›å®Œäº†',
        steps:['ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„'],
        note:''
      }
    },
    json:{
      ios:{
        title:'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†',
        steps:[
          'â‘  Safari ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆâ†“ ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’ã‚¿ãƒƒãƒ—',
          'â‘¡ ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã‚¿ãƒƒãƒ— â†’ ã€Œå…±æœ‰ã€â†’ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€',
          'â‘¢ iCloud Drive ã«ä¿å­˜ã™ã‚‹ã¨ã€ä»–ã®ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™',
          'â‘£ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒª â†’ iCloud Drive ã§ç¢ºèªã§ãã¾ã™',
        ],
        note:'ğŸ’¡ å¾©å…ƒæ™‚ï¼šè¨­å®šãƒšãƒ¼ã‚¸ã®ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã€ï¼ˆæœªå®Ÿè£…ï¼‰ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿ã‚’æ‰‹å‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆ'
      },
      android:{
        title:'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†',
        steps:[
          'â‘  é€šçŸ¥ãƒãƒ¼ã‚’ä¸‹ã«ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€šçŸ¥ã‚’ã‚¿ãƒƒãƒ—',
          'â‘¡ ã¾ãŸã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒª â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€',
          'â‘¢ Google ãƒ‰ãƒ©ã‚¤ãƒ–ã«ç§»å‹•ã—ã¦ãŠãã¨å®‰å…¨ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ãã¾ã™',
        ],
        note:'ğŸ’¡ Google ãƒ‰ãƒ©ã‚¤ãƒ–ã¸ï¼šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é•·æŠ¼ã— â†’ ã€Œå…±æœ‰ã€â†’ Drive ã‚’é¸æŠ'
      },
      mac:{
        title:'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†',
        steps:[
          'â‘  Finder â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆâŒ˜+Option+Lï¼‰',
          'â‘¡ å¤§åˆ‡ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ iCloud Drive ã‚„å¤–ä»˜ã‘ãƒ‰ãƒ©ã‚¤ãƒ–ã«ç§»å‹•ã‚’æ¨å¥¨',
        ],
        note:''
      },
      windows:{
        title:'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†',
        steps:[
          'â‘  ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€ï¼ˆWin+E â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰',
          'â‘¡ å¤§åˆ‡ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¯ OneDrive ã‚„å¤–ä»˜ã‘ãƒ‰ãƒ©ã‚¤ãƒ–ã«ç§»å‹•ã‚’æ¨å¥¨',
        ],
        note:''
      },
      other:{
        title:'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†',
        steps:['ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„'],
        note:''
      }
    },
    receipt:{
      ios:{
        title:'é ˜åæ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†',
        steps:[
          'â‘  Safari ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼ˆâ†“ ã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã‚’ã‚¿ãƒƒãƒ—',
          'â‘¡ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¿ãƒƒãƒ— â†’ ã€Œå…±æœ‰ã€â†’ã€Œå†™çœŸã«è¿½åŠ ã€ã¾ãŸã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã€',
          'â‘¢ å°åˆ·ï¼šå†™çœŸã‚¢ãƒ—ãƒªã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‹ã‚‰ã€Œãƒ—ãƒªãƒ³ãƒˆã€ã‚’é¸æŠ',
        ],
        note:'ğŸ’¡ ã‚µãƒ¼ãƒãƒ«ãƒ—ãƒªãƒ³ã‚¿ã¸ã®è»¢é€ã¯ã€ãƒ—ãƒªãƒ³ã‚¿ã®ã‚¢ãƒ—ãƒªçµŒç”±ãŒç¢ºå®Ÿã§ã™'
      },
      android:{
        title:'é ˜åæ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†',
        steps:[
          'â‘  é€šçŸ¥ãƒãƒ¼ã‚’ä¸‹ã«ã‚¹ãƒ¯ã‚¤ãƒ— â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é€šçŸ¥ã‚’ã‚¿ãƒƒãƒ—',
          'â‘¡ ã¾ãŸã¯ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒª â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€',
          'â‘¢ å°åˆ·ï¼šç”»åƒã‚’é–‹ã„ã¦ã€Œå…±æœ‰ã€â†’ã€Œå°åˆ·ã€ã¾ãŸã¯ãƒ—ãƒªãƒ³ã‚¿ã‚¢ãƒ—ãƒªã¸é€ä¿¡',
        ],
        note:'ğŸ’¡ ã‚µãƒ¼ãƒãƒ«ãƒ—ãƒªãƒ³ã‚¿ã‚¢ãƒ—ãƒªã«ç›´æ¥å…±æœ‰ã™ã‚‹æ–¹æ³•ãŒæœ€ã‚‚æ‰‹è»½ã§ã™'
      },
      mac:{
        title:'é ˜åæ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†',
        steps:[
          'â‘  Finder â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€',
          'â‘¡ ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º â†’ âŒ˜+P ã§å°åˆ·',
        ],
        note:''
      },
      windows:{
        title:'é ˜åæ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†',
        steps:[
          'â‘  ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ãƒ¼ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ãƒ•ã‚©ãƒ«ãƒ€',
          'â‘¡ ç”»åƒã‚’é–‹ã„ã¦å³ã‚¯ãƒªãƒƒã‚¯ â†’ã€Œå°åˆ·ã€',
        ],
        note:''
      },
      other:{
        title:'é ˜åæ›¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†',
        steps:['ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã‹ã‚‰å°åˆ·ã—ã¦ãã ã•ã„'],
        note:''
      }
    }
  };

  const g=guides[type][os]||guides[type]['other'];
  document.getElementById('dl-complete-title').textContent=g.title;

  const stepsHtml=g.steps.map((s,i)=>`
    <div style="padding:3px 0;${i>0?'border-top:1px solid var(--border);margin-top:4px;padding-top:6px':''}">${s}</div>
  `).join('');

  document.getElementById('dl-complete-guide').innerHTML=
    stepsHtml +
    (g.note?`<div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border);font-size:12px;color:var(--text3)">${g.note}</div>`:'');

  document.getElementById('dl-complete-modal').classList.add('open');
}
function closeDlCompleteModal(){document.getElementById('dl-complete-modal').classList.remove('open');}

// ===========================
// ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ
// ===========================
const CAT_COLORS = [
  {bg:'#9BB5CC',text:'#1A2D3E'},
  {bg:'#89B4A0',text:'#1A3028'},
  {bg:'#A89BC8',text:'#221540'},
  {bg:'#9DBDAD',text:'#163025'},
  {bg:'#A8BAD8',text:'#162440'},
  {bg:'#B5A9C8',text:'#251840'},
  {bg:'#8DB5B5',text:'#143030'},
  {bg:'#BDB5A0',text:'#302818'},
];
const catColorMap = {};
function getCatColor(cat) {
  if (!cat) return null;
  if (!catColorMap[cat]) {
    const keys = Object.keys(catColorMap).length;
    catColorMap[cat] = CAT_COLORS[keys % CAT_COLORS.length];
  }
  return catColorMap[cat];
}

// ===========================
// DB
// ===========================
let db;
function initDB() {
  return new Promise((res,rej) => {
    const req = indexedDB.open('RegisterApp',2);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('products')) d.createObjectStore('products',{keyPath:'id',autoIncrement:true});
      if (!d.objectStoreNames.contains('sales'))    d.createObjectStore('sales',   {keyPath:'id',autoIncrement:true});
      if (!d.objectStoreNames.contains('settings')) d.createObjectStore('settings',{keyPath:'key'});
    };
    req.onsuccess = e => { db=e.target.result; res(); };
    req.onerror   = e => rej(e.target.error);
  });
}
const dbGet    = (s,k) => new Promise((r,j)=>{const q=db.transaction(s).objectStore(s).get(k);q.onsuccess=()=>r(q.result);q.onerror=()=>j(q.error);});
const dbGetAll = (s)   => new Promise((r,j)=>{const q=db.transaction(s).objectStore(s).getAll();q.onsuccess=()=>r(q.result);q.onerror=()=>j(q.error);});
const dbPut    = (s,o) => new Promise((r,j)=>{const q=db.transaction(s,'readwrite').objectStore(s).put(o);q.onsuccess=()=>r(q.result);q.onerror=()=>j(q.error);});
const dbDelete = (s,k) => new Promise((r,j)=>{const q=db.transaction(s,'readwrite').objectStore(s).delete(k);q.onsuccess=()=>r();q.onerror=()=>j(q.error);});
const dbClear  = (s)   => new Promise((r,j)=>{const q=db.transaction(s,'readwrite').objectStore(s).clear();q.onsuccess=()=>r();q.onerror=()=>j(q.error);});

// ===========================
// çŠ¶æ…‹
// ===========================
let cart=[],products=[],lastSale=null,receivedAmount=0,pmIsNew=false;
let csvArchiveProcessed={};
let storeLogo=null; // base64

// ===========================
// åˆæœŸåŒ–
// ===========================
async function init() {
  await initDB();
  initEmojiGrid();
  await loadProducts();
  await loadSettings();
  renderCart();
}
function updateDateDisplay(){
  const n=new Date();
  document.getElementById('register-date').textContent=`${n.getFullYear()}å¹´${n.getMonth()+1}æœˆ${n.getDate()}æ—¥ï¼ˆ${'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[n.getDay()]}ï¼‰`;
}

// ===========================
// è¨­å®š
// ===========================
async function loadSettings(){
  for(const[k,id]of[['storeName','store-name'],['storeEmail','store-email'],['storeMessage','store-message']]){
    const v=await dbGet('settings',k);if(v)document.getElementById(id).value=v.value;
  }
  const lg=await dbGet('settings','storeLogo');
  if(lg&&lg.value){ storeLogo=lg.value; renderLogoPreview(storeLogo); }
}
async function saveSetting(key,value){await dbPut('settings',{key,value});}

// ãƒ­ã‚´
function onLogoSelected(input){
  const file=input.files[0];if(!file)return;
  if(file.size>3*1024*1024){showToast('3MBä»¥ä¸‹ã®ç”»åƒã‚’é¸ã‚“ã§ãã ã•ã„','error');return;}
  const reader=new FileReader();
  reader.onload=async e=>{
    storeLogo=e.target.result;
    await saveSetting('storeLogo',storeLogo);
    renderLogoPreview(storeLogo);
    document.getElementById('logo-clear-btn').style.display='';
    showToast('ãƒ­ã‚´ã‚’è¨­å®šã—ã¾ã—ãŸ','success');
  };
  reader.readAsDataURL(file);
}
function renderLogoPreview(src){
  const el=document.getElementById('logo-preview');
  el.innerHTML=`<img src="${src}" alt="logo">`;
  document.getElementById('logo-clear-btn').style.display='';
}
async function clearLogo(){
  storeLogo=null;
  await saveSetting('storeLogo','');
  document.getElementById('logo-preview').innerHTML='<span class="logo-empty">ãƒ­ã‚´ãªã—</span>';
  document.getElementById('logo-clear-btn').style.display='none';
  document.getElementById('logo-file-input').value='';
  showToast('ãƒ­ã‚´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ===========================
// å•†å“
// ===========================
async function loadProducts(){
  const raw=await dbGetAll('products');
  // sortOrderãŒãªã„ã‚‚ã®ã«ä»˜ä¸
  let needsSave=false;
  raw.forEach((p,i)=>{if(p.sortOrder==null){p.sortOrder=i*10;needsSave=true;}});
  if(needsSave){for(const p of raw)await dbPut('products',p);}
  // sortOrderé †ã«ã‚½ãƒ¼ãƒˆ
  products=raw.slice().sort((a,b)=>a.sortOrder-b.sortOrder);
  products.forEach(p=>{if(p.category)getCatColor(p.category);});
  renderProductGrid();
  renderProductList();
}

function renderProductGrid(){
  const el=document.getElementById('product-grid');
  if(!products.length){el.innerHTML='<div style="color:var(--text3);font-size:12px;grid-column:1/-1;text-align:center;padding:20px;">å•†å“ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>';return;}
  el.innerHTML=products.map(p=>{
    const th=p.image?`<img class="pthumb-img" src="${p.image}" alt="">`:p.emoji?`<span class="pthumb-emoji">${p.emoji}</span>`:'';
    const catColor=getCatColor(p.category);
    const catLabel=catColor&&p.category
      ?`<span class="cat-label" style="background:${catColor.bg};color:${catColor.text};margin-bottom:2px;font-size:8px;max-width:90%">${esc(p.category)}</span>`
      :'';
    const cartItem=cart.find(x=>x.id===p.id);
    const qtyBadge=cartItem?`<span class="pqty">${cartItem.qty}</span>`:'';
    return `<button class="product-btn" onclick="addToCart(${p.id})">
      ${p.isNew?'<span class="pnew">NEW</span>':''}
      ${qtyBadge}
      ${th}
      <div class="pname">${esc(p.name)}</div>
      <div class="pprice">${fmt(p.price)}</div>
      ${catLabel}
    </button>`;
  }).join('');
}

function renderProductList(){
  const el=document.getElementById('product-list-wrap');
  if(!products.length){el.innerHTML='<div class="card" style="text-align:center;color:var(--text3);font-size:13px">ã¾ã å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
  el.innerHTML=products.map(p=>{
    const th=p.image?`<img src="${p.image}" alt="">`:p.emoji?`<span class="pc-emoji">${p.emoji}</span>`:'';
    const catColor=getCatColor(p.category);
    const catLabel=catColor&&p.category
      ?`<span class="cat-label" style="background:${catColor.bg};color:${catColor.text};margin-left:6px">${esc(p.category)}</span>`:'';
    return `<div class="product-card" data-id="${p.id}">
      <div class="drag-handle" data-handle>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="4" y1="6" x2="20" y2="6"/><line x1="4" y1="12" x2="20" y2="12"/><line x1="4" y1="18" x2="20" y2="18"/>
        </svg>
      </div>
      <div class="pc-thumb">${th||'<span style="font-size:11px;color:var(--text3)">âˆ’</span>'}</div>
      <div class="pc-info">
        <div class="pc-name">${esc(p.name)}${p.isNew?'<span class="new-badge">NEW</span>':''}${catLabel}</div>
        <div class="pc-price">${fmt(p.price)}</div>
      </div>
      <div class="pc-actions">
        <button class="icon-btn icon-btn-edit" onclick="openProductModal(${p.id})">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
        </button>
        <button class="icon-btn icon-btn-del" onclick="deleteProduct(${p.id})">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
        </button>
      </div>
    </div>`;
  }).join('');
  initDragSort();
}

// ===========================
// ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ— ä¸¦ã³æ›¿ãˆ
// ===========================
function initDragSort(){
  const list=document.getElementById('product-list-wrap');
  let dragSrc=null, ghostEl=null, ghostOffsetY=0, lastOver=null;

  function getCard(el){ return el.closest('.product-card'); }
  function getCardY(card){ return card.getBoundingClientRect().top+card.getBoundingClientRect().height/2; }

  function startDrag(card, clientY){
    dragSrc=card;
    card.classList.add('dragging');
    ghostOffsetY=clientY-card.getBoundingClientRect().top;
    // ã‚´ãƒ¼ã‚¹ãƒˆç”Ÿæˆ
    ghostEl=card.cloneNode(true);
    ghostEl.style.cssText=`position:fixed;left:${card.getBoundingClientRect().left}px;width:${card.offsetWidth}px;top:${clientY-ghostOffsetY}px;z-index:999;opacity:.85;pointer-events:none;box-shadow:0 8px 24px rgba(0,0,0,.18);border-radius:14px;transition:none;`;
    document.body.appendChild(ghostEl);
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹
    document.body.style.overflow='hidden';
  }

  function moveDrag(clientY){
    if(!ghostEl)return;
    ghostEl.style.top=(clientY-ghostOffsetY)+'px';
    // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆç”»é¢ç«¯ï¼‰
    const pg=document.getElementById('p-products');
    const margin=60;
    if(clientY<margin) pg.scrollTop-=8;
    if(clientY>window.innerHeight-margin) pg.scrollTop+=8;
    // ãƒ‰ãƒ­ãƒƒãƒ—å…ˆåˆ¤å®š
    const cards=[...list.querySelectorAll('.product-card:not(.dragging)')];
    let target=null;
    for(const c of cards){
      if(clientY<getCardY(c)){target=c;break;}
    }
    // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    cards.forEach(c=>c.classList.remove('drag-over'));
    if(target!==lastOver){
      lastOver=target;
      if(target)target.classList.add('drag-over');
    }
  }

  function endDrag(){
    if(!dragSrc)return;
    dragSrc.classList.remove('dragging');
    if(ghostEl){ghostEl.remove();ghostEl=null;}
    document.body.style.overflow='';
    list.querySelectorAll('.product-card').forEach(c=>c.classList.remove('drag-over'));

    if(lastOver){
      list.insertBefore(dragSrc,lastOver);
    } else {
      list.appendChild(dragSrc);
    }
    lastOver=null;
    saveSortOrder();
    dragSrc=null;
  }

  async function saveSortOrder(){
    const cards=[...list.querySelectorAll('.product-card')];
    const newOrder=cards.map((c,i)=>({id:parseInt(c.dataset.id),sortOrder:i*10}));
    // productsé…åˆ—ã¨DBã‚’æ›´æ–°
    for(const {id,sortOrder} of newOrder){
      const p=products.find(x=>x.id===id);
      if(p){
        p.sortOrder=sortOrder;
        await dbPut('products',p);
      }
    }
    // productsé…åˆ—ã‚‚sortOrderé †ã«æ•´åˆ—
    products.sort((a,b)=>a.sortOrder-b.sortOrder);
    renderProductGrid(); // ãƒ¬ã‚¸å´ã‚‚åŒæœŸ
    showToast('é †ç•ªã‚’ä¿å­˜ã—ã¾ã—ãŸ','success');
  }

  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
  list.addEventListener('touchstart',e=>{
    const handle=e.target.closest('[data-handle]');
    if(!handle)return;
    const card=getCard(handle);
    if(!card)return;
    e.preventDefault();
    startDrag(card,e.touches[0].clientY);
  },{passive:false});

  list.addEventListener('touchmove',e=>{
    if(!dragSrc)return;
    e.preventDefault();
    moveDrag(e.touches[0].clientY);
  },{passive:false});

  list.addEventListener('touchend',e=>{
    if(!dragSrc)return;
    endDrag();
  });

  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆPCç¢ºèªç”¨ï¼‰
  list.addEventListener('mousedown',e=>{
    const handle=e.target.closest('[data-handle]');
    if(!handle)return;
    const card=getCard(handle);
    if(!card)return;
    e.preventDefault();
    startDrag(card,e.clientY);
    const onMove=ev=>{moveDrag(ev.clientY);};
    const onUp=()=>{endDrag();document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);};
    document.addEventListener('mousemove',onMove);
    document.addEventListener('mouseup',onUp);
  });
}

function toggleNew(){
  pmIsNew=!pmIsNew;
  const b=document.getElementById('new-toggle');
  if(pmIsNew){b.textContent='ON';b.style.cssText='padding:8px 20px;border-radius:99px;font-size:13px;font-weight:700;background:var(--red);color:#fff;border:1px solid var(--red);cursor:pointer;transition:all .15s';}
  else{b.textContent='OFF';b.style.cssText='padding:8px 20px;border-radius:99px;font-size:13px;font-weight:700;background:var(--s2);color:var(--text2);border:1px solid var(--border);cursor:pointer;transition:all .15s';}
}

function openProductModal(id=null){
  document.getElementById('edit-product-id').value=id||'';
  ['pm-name','pm-price','pm-category','pm-emoji'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('pm-image-file').value='';
  currentThumbImage=null;currentThumbEmoji=null;pmIsNew=false;
  document.getElementById('product-modal-title').textContent=id?'å•†å“ã‚’ç·¨é›†':'å•†å“ã‚’è¿½åŠ ';
  const b=document.getElementById('new-toggle');
  b.textContent='OFF';b.style.cssText='padding:8px 20px;border-radius:99px;font-size:13px;font-weight:700;background:var(--s2);color:var(--text2);border:1px solid var(--border);cursor:pointer;transition:all .15s';
  switchThumbTab('emoji');
  if(id){
    const p=products.find(x=>x.id===id);
    if(p){
      document.getElementById('pm-name').value=p.name;
      document.getElementById('pm-price').value=p.price;
      document.getElementById('pm-category').value=p.category||'';
      if(p.image){currentThumbImage=p.image;switchThumbTab('image');}
      else if(p.emoji){currentThumbEmoji=p.emoji;document.getElementById('pm-emoji').value=p.emoji;}
      if(p.isNew){pmIsNew=true;b.textContent='ON';b.style.cssText='padding:8px 20px;border-radius:99px;font-size:13px;font-weight:700;background:var(--red);color:#fff;border:1px solid var(--red);cursor:pointer;transition:all .15s';}
    }
  }
  updateThumbPreview();
  document.getElementById('product-modal').classList.add('open');
}
function closeProductModal(){document.getElementById('product-modal').classList.remove('open');}

async function saveProduct(){
  const name=document.getElementById('pm-name').value.trim();
  const price=parseInt(document.getElementById('pm-price').value);
  const category=document.getElementById('pm-category').value.trim();
  if(!name){showToast('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');return;}
  if(!price||price<=0){showToast('æ­£ã—ã„ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','error');return;}
  const idVal=document.getElementById('edit-product-id').value;
  const obj={name,price,category,emoji:currentThumbEmoji||null,image:currentThumbImage||null,isNew:pmIsNew};
  if(idVal){
    obj.id=parseInt(idVal);
    // æ—¢å­˜ã®sortOrderã‚’å¼•ãç¶™ã
    const existing=products.find(x=>x.id===obj.id);
    if(existing!=null)obj.sortOrder=existing.sortOrder;
  } else {
    // æ–°è¦è¿½åŠ ã¯æœ«å°¾ã«
    const max=products.reduce((m,p)=>Math.max(m,p.sortOrder||0),-1);
    obj.sortOrder=max+10;
  }
  await dbPut('products',obj);
  await loadProducts();closeProductModal();
  showToast(idVal?'å•†å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ':'å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ','success');
}
async function deleteProduct(id){
  if(!confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  await dbDelete('products',id);cart=cart.filter(c=>c.id!==id);
  await loadProducts();renderCart();showToast('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ===========================
// ã‚µãƒ ãƒã‚¤ãƒ«
// ===========================
let currentThumbEmoji=null,currentThumbImage=null;
// åŒäººå³å£²ä¼šå‘ã‘çµµæ–‡å­—ãƒ—ãƒªã‚»ãƒƒãƒˆ
// ğŸ“šæœ¬ãƒ»åŒäººèªŒ / ğŸã‚°ãƒƒã‚º / ğŸ’¿CD / ğŸ‘•ã‚¢ãƒ‘ãƒ¬ãƒ« / ãã®ä»–
const PRESET_EMOJIS=[
  // æœ¬ãƒ»åŒäººèªŒ
  'ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ“•','ğŸ““','ğŸ“’','ğŸ“”','ğŸ“ƒ','ğŸ“œ','ğŸ—’ï¸',
  // ã‚°ãƒƒã‚ºï¼šã‚¢ã‚¯ã‚¹ã‚¿ãƒ»ã‚­ãƒ¼ãƒ›ãƒ«ãƒ€ãƒ¼ãƒ»ã‚¹ãƒ†ãƒƒã‚«ãƒ¼ãƒ»ãƒ•ã‚£ã‚®ãƒ¥ã‚¢
  'ğŸª†','ğŸ—ï¸','ğŸ·ï¸','â­','ğŸ–ï¸','ğŸª…','ğŸ§¸','ğŸ','ğŸª„','ğŸ”®',
  // CDãƒ»ãƒ¡ãƒ‡ã‚£ã‚¢
  'ğŸ’¿','ğŸ“€','ğŸµ','ğŸ¶','ğŸ¤','ğŸ§','ğŸ¼','ğŸ“»',
  // ã‚¢ãƒ‘ãƒ¬ãƒ«
  'ğŸ‘•','ğŸ‘—','ğŸ§¢','ğŸ‘’','ğŸ§£','ğŸ§¤','ğŸ½','ğŸ‘”',
  // é™å®šãƒ»NEWç³»
  'ğŸ€','ğŸ','ğŸ’','âœ¨','ğŸŒŸ','ğŸ’«','ğŸ®','ğŸŠ',
  // ã‚­ãƒ£ãƒ©ãƒ»ãƒ†ãƒ¼ãƒ
  'ğŸ±','ğŸ°','ğŸ¦Š','ğŸ¼','ğŸ¸','ğŸ§','ğŸ¦‹','ğŸŒ¸',
];
function initEmojiGrid(){
  document.getElementById('emoji-grid').innerHTML=PRESET_EMOJIS.map(e=>`<button class="emoji-btn" onclick="selectEmoji('${e}')">${e}</button>`).join('');
}
function switchThumbTab(tab){
  ['emoji','image','none'].forEach(t=>document.getElementById(`tab-${t}`).classList.toggle('active',t===tab));
  document.getElementById('thumb-emoji-section').style.display=tab==='emoji'?'':'none';
  document.getElementById('thumb-image-section').style.display=tab==='image'?'':'none';
  if(tab!=='emoji')currentThumbEmoji=null;
  if(tab!=='image')currentThumbImage=null;
  updateThumbPreview();
}
function selectEmoji(e){currentThumbEmoji=e;currentThumbImage=null;document.getElementById('pm-emoji').value=e;updateThumbPreview();}
function onEmojiInput(v){currentThumbEmoji=[...v].slice(0,2).join('')||null;currentThumbImage=null;updateThumbPreview();}
function clearThumb(){currentThumbEmoji=null;currentThumbImage=null;document.getElementById('pm-emoji').value='';document.getElementById('pm-image-file').value='';switchThumbTab('none');}
function onImageSelected(input){
  const file=input.files[0];if(!file)return;
  if(file.size>2*1024*1024){showToast('2MBä»¥ä¸‹ã‚’é¸ã‚“ã§ãã ã•ã„','error');return;}
  const reader=new FileReader();
  reader.onload=e=>{
    const img=new Image();
    img.onload=()=>{
      const c=document.createElement('canvas');c.width=c.height=128;
      const ctx=c.getContext('2d');
      const min=Math.min(img.width,img.height);
      ctx.drawImage(img,(img.width-min)/2,(img.height-min)/2,min,min,0,0,128,128);
      currentThumbImage=c.toDataURL('image/jpeg',.7);currentThumbEmoji=null;updateThumbPreview();
    };img.src=e.target.result;
  };reader.readAsDataURL(file);
}
function updateThumbPreview(){
  const el=document.getElementById('thumb-preview');
  if(currentThumbImage)el.innerHTML=`<img src="${currentThumbImage}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">`;
  else if(currentThumbEmoji)el.innerHTML=`<span class="prev-emoji">${currentThumbEmoji}</span>`;
  else el.innerHTML=`<span style="font-size:11px;color:var(--text3)">ãªã—</span>`;
}

// ===========================
// ãƒ†ãƒ³ã‚­ãƒ¼
// ===========================
function cashkeyTap(val){receivedAmount+=val;updateCashkeyDisplay();}
function cashkeyClear(){receivedAmount=0;updateCashkeyDisplay();}
function updateCashkeyDisplay(){
  const total=cart.reduce((s,c)=>s+c.price*c.qty,0);
  document.getElementById('cashkey-display').textContent=receivedAmount===0?'Â¥â€”':fmt(receivedAmount);
  const area=document.getElementById('change-area');
  if(receivedAmount===0){area.innerHTML='<span class="cr-placeholder">â€”</span>';return;}
  const change=receivedAmount-total;
  area.innerHTML=`<div class="cr-label">${change<0?'ä¸è¶³é‡‘é¡':'ãŠé‡£ã‚Š'}</div><div class="cr-amount${change<0?' negative':''}">${fmt(Math.abs(change))}</div>`;
}

// ===========================
// ã‚«ãƒ¼ãƒˆ
// ===========================
function addToCart(id){
  const p=products.find(x=>x.id===id);if(!p)return;
  const ex=cart.find(c=>c.id===id);
  if(ex)ex.qty++;else cart.push({id:p.id,name:p.name,price:p.price,qty:1});
  if(!cartTimerInterval)startCartTimer();
  renderCart();if(navigator.vibrate)navigator.vibrate(30);
}
function changeQty(i,d){cart[i].qty+=d;if(cart[i].qty<=0)cart.splice(i,1);renderCart();}
let cartTimerStart=null,cartTimerInterval=null,cartAccordionOpen=true;
function toggleCartAccordion(){
  cartAccordionOpen=!cartAccordionOpen;
  const list=document.getElementById('cart-list');
  const chev=document.getElementById('cart-chevron');
  if(cartAccordionOpen){list.classList.remove('collapsed');if(chev)chev.classList.add('open');}
  else{list.classList.add('collapsed');if(chev)chev.classList.remove('open');}
}
function clearCart(){if(!cart.length)return;cart=[];receivedAmount=0;stopCartTimer();renderCart();}
function startCartTimer(){if(cartTimerInterval)return;cartTimerStart=Date.now();cartTimerInterval=setInterval(()=>{const s=Math.floor((Date.now()-cartTimerStart)/1000);const m=Math.floor(s/60);const ss=s%60;document.getElementById('cart-timer').textContent=`${m}:${String(ss).padStart(2,'0')}`;},1000);}
function stopCartTimer(){clearInterval(cartTimerInterval);cartTimerInterval=null;cartTimerStart=null;document.getElementById('cart-timer').textContent='â€”:â€”â€”';}
function renderCart(){
  const total=cart.reduce((s,c)=>s+c.price*c.qty,0);
  const totalQty=cart.reduce((s,c)=>s+c.qty,0);
  // åˆè¨ˆãƒ»ç‚¹æ•° å¸¸æ™‚è¡¨ç¤º
  document.getElementById('total').textContent=fmt(total);
  const tlbl=document.getElementById('cart-total-label');
  if(tlbl)tlbl.innerHTML=cart.length?`åˆè¨ˆ <span style="font-size:11px;font-weight:600;color:var(--text3)">${totalQty}ç‚¹</span>`:`åˆè¨ˆ`;
  document.getElementById('checkout-btn').disabled=!cart.length;
  // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰çŠ¶æ…‹ã‚’ç¶­æŒ
  const list=document.getElementById('cart-list');
  const chev=document.getElementById('cart-chevron');
  if(cartAccordionOpen){list.classList.remove('collapsed');if(chev)chev.classList.add('open');}
  else{list.classList.add('collapsed');if(chev)chev.classList.remove('open');}
  // ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã‚µãƒãƒªãƒ¼ï¼ˆæŠ˜ã‚ŠãŸãŸã¿æ™‚ã«ä¸­èº«ã‚’ã»ã®ã‚ã‹ã™ï¼‰
  const headSum=document.getElementById('cart-head-summary');
  if(headSum)headSum.textContent=(!cartAccordionOpen&&cart.length)?`${totalQty}ç‚¹ / ${fmt(total)}`:''
  if(!cart.length){
    list.innerHTML='<div class="cart-empty">å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
    document.getElementById('cashkey-display').textContent='Â¥â€”';
    document.getElementById('change-area').innerHTML='<span class="cr-placeholder">â€”</span>';
    document.getElementById('total').textContent='Â¥0';
    return;
  }
  list.innerHTML=cart.map((c,i)=>`<div class="cart-item" onclick="changeQty(${i},1)" oncontextmenu="event.preventDefault();changeQty(${i},-1)">
    <div class="ci-name">${esc(c.name)}</div>
    <div style="font-size:11px;color:var(--text3);font-family:'DM Mono',monospace;min-width:28px;text-align:center">Ã—${c.qty}</div>
    <div class="ci-price">${fmt(c.price*c.qty)}</div>
  </div>`).join('');
  renderProductGrid();
  updateCashkeyDisplay();
}

// ===========================
// ä¼šè¨ˆ
// ===========================
async function checkout(){
  if(!cart.length)return;
  const total=cart.reduce((s,c)=>s+c.price*c.qty,0);
  const received=receivedAmount||null;
  const change=received?received-total:null;
  const now=new Date();
  const sale={date:now.toISOString(),dateStr:formatDate(now),timeStr:formatTime(now),items:cart.map(c=>({...c})),total,received,change,archived:false,archiveMemo:null};
  await dbPut('sales',sale);
  lastSale={...sale};
  document.getElementById('co-summary').textContent=`${sale.timeStr} Â· ${cart.length}å“ç›® Â· åˆè¨ˆ ${fmt(total)}`;
  const cdEl=document.getElementById('co-change-display');
  if(change!==null){document.getElementById('co-change').textContent=fmt(Math.abs(change));document.getElementById('co-change').style.color=change<0?'var(--red)':'var(--green)';cdEl.style.display='block';}
  else cdEl.style.display='none';
  document.getElementById('checkout-modal').classList.add('open');
  cart=[];receivedAmount=0;stopCartTimer();renderCart();
  await renderHistory();
}
function closeCheckoutModal(){document.getElementById('checkout-modal').classList.remove('open');}

// ===========================
// é ˜åæ›¸ Canvasç”Ÿæˆï¼ˆç™½é»’ãƒ»ã‚µãƒ¼ãƒãƒ«å‘ã‘ï¼‰
// ===========================
async function showReceiptModal(){
  if(!lastSale)return;
  const sn=await dbGet('settings','storeName');
  const se=await dbGet('settings','storeEmail');
  const sm=await dbGet('settings','storeMessage');
  const name=sn?.value||'ã‚µãƒ¼ã‚¯ãƒ«å';
  const email=se?.value||'';
  const msg=sm?.value||'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ';

  await drawReceiptCanvas(lastSale,{name,email,msg,logo:storeLogo});
  document.getElementById('receipt-modal').classList.add('open');
}

async function drawReceiptCanvas(sale,{name,email,msg,logo}){
  const W=380;
  const canvas=document.getElementById('receipt-canvas');
  const ctx=canvas.getContext('2d');

  // ãƒ•ã‚©ãƒ³ãƒˆèª­ã¿è¾¼ã¿å¾…æ©Ÿ
  await document.fonts.ready;

  // --- è¡Œãƒªã‚¹ãƒˆç”Ÿæˆï¼ˆé«˜ã•è¨ˆç®—ç”¨ï¼‰---
  const FONT='Noto Sans JP, sans-serif';
  const LINE=22;
  const PAD=20;

  // ãƒ­ã‚´ãŒã‚ã‚‹å ´åˆã®é«˜ã•
  let logoH=0;
  let logoImg=null;
  if(logo){
    try{
      logoImg=await new Promise((r,j)=>{const i=new Image();i.onload=()=>r(i);i.onerror=j;i.src=logo;});
      logoH=70;
    }catch(e){logoImg=null;}
  }

  // è¡Œã‚’æ§‹æˆ
  const items=sale.items;
  const rows=[];
  rows.push({type:'title',text:'é ˜ã€€åã€€æ›¸'});
  rows.push({type:'divider'});
  rows.push({type:'text',text:name,bold:true,size:15});
  if(email)rows.push({type:'text',text:`âœ‰ ${email}`,size:12,color:'#555'});
  rows.push({type:'divider'});
  rows.push({type:'kv',key:'ç™ºè¡Œæ—¥æ™‚',val:`${sale.dateStr} ${sale.timeStr}`});
  rows.push({type:'divider'});
  items.forEach(i=>{
    rows.push({type:'kv',key:i.name,val:`${fmt(i.price)} Ã— ${i.qty}`});
  });
  rows.push({type:'divider'});
  rows.push({type:'kv',key:'åˆã€€è¨ˆ',val:fmt(sale.total),bold:true,big:true});
  if(sale.received){rows.push({type:'kv',key:'ãŠé ã‹ã‚Š',val:fmt(sale.received)});}
  if(sale.change!==null){rows.push({type:'kv',key:'ãŠã€€é‡£ã€€ã‚Š',val:fmt(Math.abs(sale.change))});}
  rows.push({type:'divider'});
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æŠ˜ã‚Šè¿”ã—ï¼ˆå¹…W-PAD*2ã§wrapï¼‰
  if(msg){rows.push({type:'multicenter',text:msg,size:13});}
  rows.push({type:'space'});

  // é«˜ã•è¨ˆç®—
  let totalH=PAD*2+logoH;
  // multicenter ã®è¡Œæ•°ã‚’äº‹å‰è¨ˆç®—
  const tmpCtxH=document.createElement('canvas').getContext('2d');
  rows.forEach(r=>{
    if(r.type==='divider')totalH+=14;
    else if(r.type==='space')totalH+=10;
    else if(r.type==='multicenter'){
      tmpCtxH.font=`400 ${r.size||13}px Noto Sans JP, sans-serif`;
      const words=[...r.text];
      const maxW=W-PAD*2;
      let line='',lines=0;
      for(const ch of words){
        const test=line+ch;
        if(tmpCtxH.measureText(test).width>maxW&&line){lines++;line=ch;}
        else line=test;
      }
      if(line)lines++;
      r._lines=lines||1;
      totalH+=LINE*r._lines+4;
    }
    else totalH+=LINE+(r.big?8:0);
  });

  canvas.width=W*2; canvas.height=totalH*2;
  canvas.style.width=W+'px'; canvas.style.height=totalH+'px';
  ctx.scale(2,2);

  // ç™½èƒŒæ™¯
  ctx.fillStyle='#ffffff';
  ctx.fillRect(0,0,W,totalH);

  let y=PAD;

  // ãƒ­ã‚´æç”»ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
  if(logoImg){
    // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«å¤‰æ›
    const tmpC=document.createElement('canvas');
    tmpC.width=logoImg.naturalWidth;tmpC.height=logoImg.naturalHeight;
    const tmpCtx=tmpC.getContext('2d');
    tmpCtx.drawImage(logoImg,0,0);
    const id=tmpCtx.getImageData(0,0,tmpC.width,tmpC.height);
    for(let i=0;i<id.data.length;i+=4){
      const g=0.299*id.data[i]+0.587*id.data[i+1]+0.114*id.data[i+2];
      id.data[i]=id.data[i+1]=id.data[i+2]=g;
    }
    tmpCtx.putImageData(id,0,0);

    const ratio=logoImg.naturalWidth/logoImg.naturalHeight;
    const lW=Math.min(160,ratio*(logoH-10));
    ctx.drawImage(tmpC,(W-lW)/2,y,lW,lW/ratio);
    y+=logoH;
  }

  // è¡Œæç”»
  rows.forEach(r=>{
    ctx.fillStyle='#000';
    if(r.type==='divider'){
      ctx.strokeStyle='#bbb';ctx.lineWidth=0.7;
      ctx.beginPath();ctx.moveTo(PAD,y+6);ctx.lineTo(W-PAD,y+6);ctx.stroke();
      y+=14;
    } else if(r.type==='space'){
      y+=10;
    } else if(r.type==='title'){
      ctx.font=`900 18px ${FONT}`;ctx.textAlign='center';ctx.fillStyle='#000';
      ctx.fillText(r.text,W/2,y+15);y+=LINE+4;
    } else if(r.type==='center'){
      ctx.font=`${r.bold?'700':'400'} ${r.size||13}px ${FONT}`;ctx.textAlign='center';
      ctx.fillStyle=r.color||'#444';
      ctx.fillText(r.text,W/2,y+13);y+=LINE;
    } else if(r.type==='multicenter'){
      ctx.font=`400 ${r.size||13}px ${FONT}`;ctx.textAlign='center';
      ctx.fillStyle=r.color||'#444';
      const maxW=W-PAD*2;
      const chars=[...r.text];
      let line='';
      const wrappedLines=[];
      for(const ch of chars){
        const test=line+ch;
        if(ctx.measureText(test).width>maxW&&line){wrappedLines.push(line);line=ch;}
        else line=test;
      }
      if(line)wrappedLines.push(line);
      wrappedLines.forEach((l,i)=>{ctx.fillText(l,W/2,y+13+LINE*i);});
      y+=LINE*(wrappedLines.length||1)+4;
    } else if(r.type==='text'){
      ctx.font=`${r.bold?'700':'400'} ${r.size||14}px ${FONT}`;ctx.textAlign='left';
      ctx.fillStyle=r.color||'#000';
      ctx.fillText(r.text,PAD,y+14);y+=LINE;
    } else if(r.type==='kv'){
      const fs=r.big?16:13;
      ctx.font=`${r.bold?'700':'400'} ${fs}px ${FONT}`;
      ctx.textAlign='left';ctx.fillStyle='#000';
      ctx.fillText(r.key,PAD,y+fs);
      ctx.textAlign='right';ctx.font=`${r.bold?'700':'500'} ${fs}px 'DM Mono',monospace`;
      ctx.fillText(r.val,W-PAD,y+fs);
      y+=LINE+(r.big?8:0);
    }
  });
}

function downloadReceiptPng(){
  const canvas=document.getElementById('receipt-canvas');
  const a=document.createElement('a');
  a.href=canvas.toDataURL('image/png');
  const recFilename=`receipt-${lastSale?.dateStr?.replace(/\//g,'')}-${lastSale?.timeStr?.replace(/:/g,'')}.png`;
  a.download=recFilename;
  a.click();
  showDlCompleteModal('receipt', recFilename);
}
function closeReceiptModal(){document.getElementById('receipt-modal').classList.remove('open');}

// ===========================
// ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
// ===========================
function openArchiveModal(id){
  document.getElementById('archive-target-id').value=id;
  document.getElementById('archive-memo').value='';
  document.getElementById('archive-modal').classList.add('open');
}
function closeArchiveModal(){document.getElementById('archive-modal').classList.remove('open');}
async function confirmArchive(){
  const id=parseInt(document.getElementById('archive-target-id').value);
  const memo=document.getElementById('archive-memo').value.trim();
  const sale=await dbGet('sales',id);if(!sale)return;
  sale.archived=true;sale.archiveMemo=memo||null;
  await dbPut('sales',sale);
  closeArchiveModal();closeHistoryModal();
  await renderHistory();showToast('ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ');
}

// ===========================
// å±¥æ­´
// ===========================
async function renderHistory(){
  const sales=await dbGetAll('sales');
  sales.sort((a,b)=>new Date(b.date)-new Date(a.date));
  const todayStr=formatDate(new Date());
  const todaySales=sales.filter(s=>s.dateStr===todayStr&&!s.archived);
  const todayTotal=todaySales.reduce((s,x)=>s+x.total,0);
  const archCount=sales.filter(s=>s.archived).length;
  // CSVå‡ºåŠ›æ¸ˆã¿ãƒãƒƒã‚¸å¾©å…ƒ
  const lastCsv=await dbGet('settings','lastCsvExport');
  const badge=document.getElementById('csv-exported-badge');
  if(badge)badge.style.display=lastCsv&&lastCsv.value?'':'none';
  // å•†å“åˆ¥è²©å£²æ•°ï¼ˆæœ¬æ—¥ã®ã¿ãƒ»éã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰
  const todayItemMap={};
  todaySales.forEach(s=>s.items.forEach(it=>{
    if(!todayItemMap[it.id])todayItemMap[it.id]={name:it.name,qty:0,total:0};
    todayItemMap[it.id].qty+=it.qty;
    todayItemMap[it.id].total+=it.price*it.qty;
  }));
  const sortedTodayItems=products.filter(p=>todayItemMap[p.id]).map(p=>({...todayItemMap[p.id],id:p.id}));
  Object.entries(todayItemMap).forEach(([id,v])=>{if(!products.find(p=>p.id===parseInt(id)))sortedTodayItems.push({id:parseInt(id),...v});});
  const itemBreakdownHtml=sortedTodayItems.length?`
    <div style="margin-top:10px;border-top:1px solid rgba(0,0,0,.08);padding-top:8px">
      <div style="font-size:10px;font-weight:700;color:var(--accent);letter-spacing:1px;margin-bottom:6px">å•†å“åˆ¥ è²©å£²æ•°</div>
      ${sortedTodayItems.map(it=>`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:12px">
          <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding-right:8px;color:var(--text2)">${esc(it.name)}</span>
          <span style="font-family:'DM Mono',monospace;color:var(--text3);margin-right:10px">${it.qty}å€‹</span>
          <span style="font-family:'DM Mono',monospace;color:var(--accent)">${fmt(it.total)}</span>
        </div>`).join('')}
    </div>`:'';
  document.getElementById('today-summary-wrap').innerHTML=`
    <div class="today-summary">
      <div class="ts-title">TODAY â€” ${todayStr}</div>
      <div class="ts-grid">
        <div class="ts-item"><div class="ts-label">æœ¬æ—¥å£²ä¸Š</div><div class="ts-value">${fmt(todayTotal)}</div></div>
        <div class="ts-item"><div class="ts-label">ä¼šè¨ˆä»¶æ•°</div><div class="ts-value">${todaySales.length}<span class="ts-unit"> ä»¶</span></div></div>
      </div>
      ${itemBreakdownHtml}
      ${archCount>0?`<div style="margin-top:10px;font-size:12px;color:var(--red);font-weight:700">âš  ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– ${archCount}ä»¶ â€” CSVå‡ºåŠ›å‰ã«å‡¦ç†ãŒå¿…è¦ã§ã™</div>`:''}
    </div>`;
  const listEl=document.getElementById('history-list-wrap');
  if(!sales.length){listEl.innerHTML='<div class="card" style="text-align:center;color:var(--text3);font-size:13px">ã¾ã ä¼šè¨ˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
  const groups={};
  sales.forEach(s=>{if(!groups[s.dateStr])groups[s.dateStr]=[];groups[s.dateStr].push(s);});
  let html='';
  for(const[date,list]of Object.entries(groups)){
    const dayTotal=list.filter(s=>!s.archived).reduce((s,x)=>s+x.total,0);
    html+=`<div class="date-sep">${date}ã€€æœ‰åŠ¹ ${fmt(dayTotal)}ã€€${list.filter(s=>!s.archived).length}ä»¶</div>`;
    html+=list.map(s=>`
      <div class="history-item ${s.archived?'archived':''}" onclick="showHistoryDetail(${s.id})">
        <div class="hi-header">
          <div class="hi-left">${s.archived?'<div class="hi-archived-label">ARCHIVED</div>':''}<div class="hi-time">${s.timeStr}</div></div>
          <div class="hi-amount">${fmt(s.total)}</div>
        </div>
        <div class="hi-items">${s.items.map(i=>`<div class="hi-tag">${esc(i.name)} Ã—${i.qty}</div>`).join('')}</div>
      </div>`).join('');
  }
  listEl.innerHTML=html;
}

async function showHistoryDetail(id){
  const sale=await dbGet('sales',id);if(!sale)return;
  const archSec=!sale.archived
    ?`<button class="btn btn-red btn-sm" style="width:auto;margin-top:14px" onclick="openArchiveModal(${id})">ã“ã®ä¼šè¨ˆã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</button>`
    :`<div style="margin-top:14px;padding:10px 12px;background:rgba(224,85,85,.08);border:1px solid rgba(224,85,85,.2);border-radius:var(--rs)">
        <div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:4px">ARCHIVED</div>
        <div style="font-size:13px;color:var(--text2)">${sale.archiveMemo?esc(sale.archiveMemo):'ãƒ¡ãƒ¢ãªã—'}</div>
      </div>`;
  document.getElementById('history-detail-content').innerHTML=`
    <div class="modal-title">${sale.dateStr} ${sale.timeStr}</div>
    <div>
      ${sale.items.map(i=>`<div class="hdi-row"><span>${esc(i.name)}</span><span class="hdi-val">${fmt(i.price)} Ã— ${i.qty} = ${fmt(i.price*i.qty)}</span></div>`).join('')}
      <div class="hdi-row" style="font-weight:700"><span>åˆè¨ˆ</span><span style="color:var(--accent);font-family:'DM Mono',monospace;font-size:18px">${fmt(sale.total)}</span></div>
      ${sale.received?`<div class="hdi-row"><span style="color:var(--text2)">ãŠé ã‹ã‚Š</span><span class="hdi-val">${fmt(sale.received)}</span></div>`:''}
      ${sale.change!==null?`<div class="hdi-row"><span style="color:var(--text2)">ãŠé‡£ã‚Š</span><span class="hdi-val" style="color:var(--green)">${fmt(Math.abs(sale.change))}</span></div>`:''}
    </div>
    ${archSec}<br>`;
  document.getElementById('history-modal').classList.add('open');
}
function closeHistoryModal(){document.getElementById('history-modal').classList.remove('open');}

// ===========================
// CSVå‡ºåŠ›
// ===========================
async function startCsvExport(){
  const sales=await dbGetAll('sales');
  const archived=sales.filter(s=>s.archived);
  if(!archived.length){await proceedCsvExport();return;}
  csvArchiveProcessed={};
  renderCsvArchiveList(archived);
  document.getElementById('csv-proceed-btn').disabled=true;
  document.getElementById('csv-archive-modal').classList.add('open');
}
function renderCsvArchiveList(archived){
  document.getElementById('csv-archive-list').innerHTML=archived.map(s=>`
    <div class="archive-item-row" id="air-${s.id}">
      <div class="air-header"><span class="air-time">${s.dateStr} ${s.timeStr}</span><span class="air-amount">${fmt(s.total)}</span></div>
      ${s.archiveMemo?`<div class="air-memo">${esc(s.archiveMemo)}</div>`:''}
      <div class="air-btns">
        <button class="btn btn-red btn-sm" id="air-del-${s.id}" onclick="setArchiveAction(${s.id},'delete')">å‰Šé™¤</button>
        <button class="btn btn-ghost btn-sm" id="air-mrg-${s.id}" onclick="setArchiveAction(${s.id},'merge')">ãƒãƒ¼ã‚¸</button>
      </div>
    </div>`).join('');
}
function setArchiveAction(id,action){
  csvArchiveProcessed[id]=action;
  ['delete','merge'].forEach(a=>{
    const b=document.getElementById(a==='delete'?`air-del-${id}`:`air-mrg-${id}`);
    b.style.opacity=action===a?'1':'0.4';
    b.style.outline=action===a?(a==='delete'?'2px solid var(--red)':'2px solid var(--accent)'):'';
  });
  checkCsvProceedBtn();
}
async function bulkArchiveAction(action){
  const sales=await dbGetAll('sales');
  sales.filter(s=>s.archived).forEach(s=>setArchiveAction(s.id,action));
}
async function checkCsvProceedBtn(){
  const sales=await dbGetAll('sales');
  const archived=sales.filter(s=>s.archived);
  document.getElementById('csv-proceed-btn').disabled=!archived.every(s=>csvArchiveProcessed[s.id]);
}
async function proceedCsvExport(){
  const sales=await dbGetAll('sales');
  for(const sale of sales.filter(s=>s.archived)){
    const action=csvArchiveProcessed[sale.id];
    if(action==='delete')await dbDelete('sales',sale.id);
    else if(action==='merge'){sale.archived=false;sale.archiveMemo=null;await dbPut('sales',sale);}
  }
  const final=(await dbGetAll('sales')).filter(s=>!s.archived);
  final.sort((a,b)=>new Date(a.date)-new Date(b.date));
  let csv='\uFEFFæ—¥ä»˜,æ™‚åˆ»,å•†å“å,å˜ä¾¡,æ•°é‡,å°è¨ˆ,åˆè¨ˆ\n';
  final.forEach(s=>{s.items.forEach((item,i)=>{csv+=`${s.dateStr},${s.timeStr},"${item.name}",${item.price},${item.qty},${item.price*item.qty},${i===0?s.total:''}\n`;});});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download=`sales-${formatDate(new Date()).replace(/\//g,'-')}.csv`;
  a.click();
  const csvFilename=`sales-${formatDate(new Date()).replace(/\//g,'-')}.csv`;
  closeCsvArchiveModal();await renderHistory();
  const badge=document.getElementById('csv-exported-badge');if(badge)badge.style.display='';
  await saveSetting('lastCsvExport',new Date().toISOString());
  showDlCompleteModal('csv', csvFilename);
}
function closeCsvArchiveModal(){document.getElementById('csv-archive-modal').classList.remove('open');}

// ===========================
// ãƒ‡ãƒ¼ã‚¿ç®¡ç†
// ===========================
async function exportJson(){
  const data=JSON.stringify({products:await dbGetAll('products'),sales:await dbGetAll('sales'),settings:await dbGetAll('settings')},null,2);
  const jsonFilename=`register-backup-${formatDate(new Date()).replace(/\//g,'-')}.json`;
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([data],{type:'application/json'}));
  a.download=jsonFilename;a.click();
  showDlCompleteModal('json', jsonFilename);
}
async function confirmClearHistory(){
  if(!confirm('å£²ä¸Šå±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'))return;
  await dbClear('sales');await renderHistory();showToast('å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
}

// ===========================
// ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
// ===========================
async function showPage(name,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(`p-${name}`).classList.add('active');
  btn.classList.add('active');
  if(name==='history')await renderHistory();
  if(name==='settings')showStorageInfo();
  if(name==='register')renderProductGrid();
}

async function showStorageInfo(){
  const el=document.getElementById('db-storage-info');
  if(!el)return;
  try{
    if(navigator.storage&&navigator.storage.estimate){
      const est=await navigator.storage.estimate();
      const used=est.usage?Math.round(est.usage/1024)+'KB':null;
      const quota=est.quota?Math.round(est.quota/1024/1024)+'MB':null;
      el.textContent=used?`ä½¿ç”¨å®¹é‡: ç´„${used}${quota?' / ä¸Šé™ç´„'+quota:''}`: 'å®¹é‡æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
    } else { el.textContent='ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å®¹é‡æƒ…å ±ã®å–å¾—ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'; }
  }catch(e){ el.textContent='å®¹é‡æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ'; }
}

// ===========================
// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯
// ===========================
['product-modal','history-modal','checkout-modal','receipt-modal','archive-modal','csv-archive-modal','dl-complete-modal'].forEach(id=>{
  document.getElementById(id).addEventListener('click',e=>{
    if(e.target.id!==id)return;
    if(id==='product-modal')closeProductModal();
    if(id==='history-modal')closeHistoryModal();
    if(id==='checkout-modal')closeCheckoutModal();
    if(id==='receipt-modal')closeReceiptModal();
    if(id==='archive-modal')closeArchiveModal();
    if(id==='csv-archive-modal')closeCsvArchiveModal();
    if(id==='dl-complete-modal')closeDlCompleteModal();
  });
});

// ===========================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ===========================
function fmt(n){return'Â¥'+n.toLocaleString('ja-JP');}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function formatDate(d){return`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;}
function formatTime(d){return`${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;}
let toastTimer;
function showToast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg;el.className='toast show'+(type?' '+type:'');
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>el.className='toast',2200);
}

init();
</script>
</body>
</html>
